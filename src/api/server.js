var express = require("express");
const parser = require("body-parser");
const { spawn } = require("child_process");
var app = express();

let jobStarted = false;

app.use(parser.urlencoded({extended : true}));
app.post("/start", function(request, response) {
    if (!request.body.url || !request.body.siteMapPath) {
        response.send("Please provide the `url` and `siteMapPath`.");
        return;
    }

    if (!jobStarted) {
        jobStarted = true;

        const xvfbRun = spawn("xvfb-run", 
            [
                "-a", 
                "--", 
                "node", 
                "run", 
                "follow-links-extract", 
                "--url", 
                request.body.url, 
                "--map", 
                request.body.siteMapPath
            ]
        );

        xvfbRun.stdout.on("data", data => {
            console.log(`stdout: ${data}`);
        });

        xvfbRun.stderr.on("data", data => {
            console.log(`stderr: ${data}`);
        });

        xvfbRun.on('error', (error) => {
            console.log(`error: ${error.message}`);
        });

        xvfbRun.on("close", code => {
            jobStarted = false;
            console.log(`child process exited with code ${code}`);
            xvfbRun.kill(9);
        });
        
        response.send("Job started. Please check Cloud Run logs for more infos...");
    } else {
        response.send("Job already started. Please check Cloud Run logs for more infos...");
    }
});

app.listen(8080);