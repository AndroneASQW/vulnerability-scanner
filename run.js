const { parseRunScriptArguments } = require('./src/utils/cliArgumentParsing');
const { setupFileLogger, setupGoogleCloudLogger } = require('./src/utils/logger');
const { launchHeadfulBrowserDefault} = require('newsfeel-browser');
const logger = require('./src/utils/logger');
const extractorAPI = require('./src/extractor/api');
const { Scheduler } = require('./src/scheduler/scheduler');

(async () => {
    const args = parseRunScriptArguments();

    // Check arguments
    if (args._.length == 0) {
        console.log(
            'No running mode specified. Run `npm run --help` for more details.'
        );
        process.exit();
    }
    const runningMode = args._[0];
    const supportedModes = ['extract', 'follow-links-extract'];
    if (!supportedModes.includes(runningMode)) {
        console.log(
            `Running mode not supported. Expected one of ${supportedModes}.`
        );
        process.exit();
    }

    // Initialize logger
    setupFileLogger(args.logFile);
    logger.info('Started job');

    // Initialize NewsFeelBrowser
    const newsfeelBrowser = await launchHeadfulBrowserDefault(
        args.chromeProfile, args.abpPath,
    );
    logger.info('Initialized browser successfully');

    try {
        if (args._[0] == "extract") {
            await extractorAPI.runExtractionWithArguments(newsfeelBrowser, args);
        } else {
            const scheduler = new Scheduler(newsfeelBrowser, args.props);
            await extractorAPI.runFollowLinksExtraction(scheduler, args);
        }
    } finally {
        await newsfeelBrowser.close();
        logger.info('Job finished', 'Info');
    }
})();
